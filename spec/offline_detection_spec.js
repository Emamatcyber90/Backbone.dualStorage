// Generated by CoffeeScript 1.9.3
(function() {
  var Collection, Model, backboneSync, dualSync, localStorage, localSync, ref,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

  backboneSync = window.backboneSync, localSync = window.localSync, dualSync = window.dualSync, localStorage = window.localStorage;

  ref = {}, Collection = ref.Collection, Model = ref.Model;

  describe('offline detection', function() {
    this.timeout(100);
    beforeEach(function() {
      localStorage.clear();
      Model = (function(superClass) {
        extend(Model, superClass);

        function Model() {
          return Model.__super__.constructor.apply(this, arguments);
        }

        Model.prototype.idAttribute = '_id';

        Model.prototype.urlRoot = 'things/';

        return Model;

      })(Backbone.Model);
      return Collection = (function(superClass) {
        extend(Collection, superClass);

        function Collection() {
          return Collection.__super__.constructor.apply(this, arguments);
        }

        Collection.prototype.model = Model;

        Collection.prototype.url = Model.prototype.urlRoot;

        return Collection;

      })(Backbone.Collection);
    });
    return describe('Backbone.DualStorage.offlineStatusCodes', function() {
      beforeEach(function() {
        return this.originalOfflineStatusCodes = Backbone.DualStorage.offlineStatusCodes;
      });
      afterEach(function() {
        return Backbone.DualStorage.offlineStatusCodes = this.originalOfflineStatusCodes;
      });
      describe('as an array property', function() {
        it('acts as offline when a server response code is in included in the array', function(done) {
          var model, saved;
          Backbone.DualStorage.offlineStatusCodes = [500, 502];
          model = new Model({
            _id: 1
          });
          saved = $.Deferred();
          model.save('name', 'original name saved locally', {
            success: function() {
              return saved.resolve();
            }
          });
          return saved.done(function() {
            var fetchedLocally, response;
            model = new Model({
              _id: 1
            });
            fetchedLocally = $.Deferred();
            response = 'response ignored because of the "offline" status code';
            model.fetch({
              errorStatus: 500,
              serverResponse: {
                name: response
              },
              success: function() {
                return fetchedLocally.resolve();
              }
            });
            return fetchedLocally.done(function() {
              expect(model.get('name')).to.equal('original name saved locally');
              return done();
            });
          });
        });
        return it('defaults to [408, 502] (Request Timeout, Bad Gateway)', function() {
          return expect(Backbone.DualStorage.offlineStatusCodes).to.eql([408, 502]);
        });
      });
      describe('as an array returned by a method', function() {
        return it('acts as offline when a server response code is in included in the array', function(done) {
          var model, saved, serverReportsToBeOffline;
          serverReportsToBeOffline = function(xhr) {
            var ref1;
            if ((xhr != null ? (ref1 = xhr.response) != null ? ref1['error_message'] : void 0 : void 0) === 'Offline for maintenance') {
              return [200];
            } else {
              return [];
            }
          };
          Backbone.DualStorage.offlineStatusCodes = serverReportsToBeOffline;
          model = new Model({
            _id: 1
          });
          saved = $.Deferred();
          model.save('name', 'original name saved locally', {
            success: function() {
              return saved.resolve();
            }
          });
          return saved.done(function() {
            var fetchedLocally;
            model = new Model({
              _id: 1
            });
            fetchedLocally = $.Deferred();
            model.fetch({
              serverResponse: {
                _id: 1,
                name: 'unknown',
                error_message: 'Offline for maintenance'
              },
              success: function() {
                return fetchedLocally.resolve();
              }
            });
            return fetchedLocally.done(function() {
              expect(model.get('name')).to.equal('original name saved locally');
              return done();
            });
          });
        });
      });
      return it('treats an ajax response status code 0 as offline, regardless of offlineStatusCodes', function(done) {
        var model, saved;
        model = new Model({
          _id: 1
        });
        saved = $.Deferred();
        model.save('name', 'original name saved locally', {
          success: function() {
            return saved.resolve();
          }
        });
        return saved.done(function() {
          var fetchedLocally, response;
          model = new Model({
            _id: 1
          });
          fetchedLocally = $.Deferred();
          response = 'response ignored because of the "offline" status code';
          model.fetch({
            errorStatus: 0,
            serverResponse: {
              name: response
            },
            success: function() {
              return fetchedLocally.resolve();
            }
          });
          return fetchedLocally.done(function() {
            expect(model.get('name')).to.equal('original name saved locally');
            return done();
          });
        });
      });
    });
  });

}).call(this);

//# sourceMappingURL=offline_detection_spec.js.map
